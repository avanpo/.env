#!/usr/bin/python
#
# Borg (and external SSD) backup script.

import datetime
import getpass
import os
import subprocess
import sys

_BACKUP_DIR = "/home/user/files"


def remote_backup():
    print("-------------")
    print("REMOTE BACKUP")
    print("-------------")

    repo = input("Please enter your borg repo location: ")
    borg_pass = getpass.getpass("Please enter your borg passphrase: ")

    env = os.environ.copy()
    env["BORG_PASSPHRASE"] = borg_pass

    # Get some stats.
    last_version = get_remote_stats(repo, env)
    get_remote_stats_for_version(repo, last_version, env)

    # Do the backup.
    new_version = datetime.date.today().strftime("%Y_%m_%d")
    if new_version == last_version:
        print("Already did a remote backup today! Skipping.")
    else:
        print("Performing backup...")
        cp = subprocess.run(
            [
                "borg", "create", "--progress", "--stats",
                f"{repo}::{new_version}", _BACKUP_DIR
            ],
            env=env,
        )
        handle_proc(cp)


def get_remote_stats(repo, env):
    print("Connecting...")
    cp = subprocess.run(
        [
            "borg",
            "list",
            "--format={archive},",  # use comma as delim
            f"{repo}",
        ],
        capture_output=True,
        text=True,
        env=env,
    )
    handle_proc(cp)
    versions = cp.stdout.strip(",").split(",")
    last_version = versions[-1]
    print(
        f"Found a total of {len(versions)} archives, with the last being \"{last_version}\"."
    )
    return last_version


def get_remote_stats_for_version(repo, last_version, env):
    print("Checking archive info...")
    cp = subprocess.run(
        [
            "borg",
            "info",
            f"{repo}::{last_version}",
        ],
        capture_output=True,
        text=True,
        env=env,
    )
    handle_proc(cp)
    num_files = cp.stdout.partition("Number of files: ")[2].partition("\n")[0]
    print(f"Number of files: {num_files}")
    archive_size = cp.stdout.partition("This archive:")[2].partition(
        "\n")[0].strip().partition("  ")[0]
    print(f"Uncompressed archive size: {archive_size}")
    total_size = cp.stdout.partition("All archives:")[2].partition(
        "\n")[0].rpartition("  ")[2].strip()
    print(f"All archives compressed size: {total_size}")


def handle_proc(result):
    if result.returncode != 0:
        print(
            f"ERROR: Exit code {result.returncode} for '{' '.join(result.args)}'."
        )
        sys.exit()


remote_backup()
